verbose = FALSE)
diffcyt::topTable(pool.res_IPI.LDH2,format_vals = TRUE,top_n=10,show_logFC =TRUE)
if(writeToFile){
write.csv(as.data.frame(  diffcyt::topTable(pool.res_IPI.LDH2,format_vals = TRUE,top_n=10,show_logFC =TRUE)),file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/IPI-effects-omitND/limma-edgeR","/IPIeffect-repeatMeasure.HighIPI_3.csv"))
}
# plotAbundanceCPMDiffCyt(d_counts=res_IPI.LDH2$d_counts,cluster="Tumor",marker=NULL,clinicalFactor="highIPI")
##states edgeR
pool.state_IPI.LDH2 <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
plot=TRUE,
contrast=createContrast(c(0,0,0,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = TRUE)
diffcyt::topTable(pool.state_IPI.LDH2,format_vals = TRUE,top_n=10,show_logFC =TRUE)
if(writeToFile){
write.csv(as.data.frame(  diffcyt::topTable(pool.state_IPI.LDH2,format_vals = TRUE,top_n=10,show_logFC =TRUE)),file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/IPI-effects-omitND/limma-edgeR/","/STATE_IPIeffect-repeatMeasure_HighIPI_3.csv"))
}
#as<-  plotMedianExpressionBoxplot(d_medians=state_IPI.LDH2$d_medians,cluster="Act_Exh_early_CD4",marker="Tim3",clinicalFactor="highIPI")
#bs<-  plotMedianExpressionBoxplot(d_medians=state_IPI.LDH2$d_medians,cluster="Hi_Supp_TREG",marker="Lag3",clinicalFactor="highIPI")
#cs<-  plotMedianExpressionBoxplot(d_medians=state_IPI.LDH2$d_medians,cluster="Term_Exh_CD8",marker="Tim3",clinicalFactor="highIPI")
#ds<-  plotMedianExpressionBoxplot(d_medians=state_IPI.LDH2$d_medians,cluster="Exh_Inflam_CD8",marker="Lag3",clinicalFactor="highIPI")
#   grid.arrange(as,bs,cs,ds, nrow=2)
############################################################
#   NGCB .vs. GCB NO CONTRAST
#######################################################
##NGCB !=0 vs. others not contrast
###################
## EDGE R
## trends should match the Mixed model.
########################
pool.ngcb_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design = design,
contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.ngcb_DA,format_vals = TRUE,top_n=10, show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(diffcyt::topTable(pool.ngcb_DA,format_vals = TRUE,top_n=10, show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/NGCB-effects-omitND-IPIadj/edgeR-repeatMeasure/","/NGCB.omitND.NGCB.vs.GCB_noContrast.RepeatMeasure.csv"))
}
# aNG<- plotAbundanceCPMDiffCyt(d_counts=ngcb_DA$d_counts,cluster="Act_prol_TREG",marker=NULL,clinicalFactor="NGCB")
# aNG2<- plotAbundanceCPMDiffCyt(d_counts=ngcb_DA$d_counts,cluster="Baseline_CD4",marker=NULL,clinicalFactor="NGCB")
#   a2<- plotAbundanceCPMDiffCyt(d_counts=ngcb_DA$d_counts,cluster="Baseline_TREG",marker=NULL,clinicalFactor="NGCB")
# b2<- plotAbundanceCPMDiffCyt(d_counts=ngcb_DA$d_counts,cluster="Exh_Inflam_CD8",marker=NULL,clinicalFactor="NGCB")
#grid.arrange(aNG,aNG2,a2,b2,nrow=2,ncol=2)
##JOINT EFFECT IPI AND NGCB JOINT EFECT.
#  chisq.test(exper_info2$highIPI,exper_info2$NGCB)
pool.joint_ngcb_IPI_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design = design,
contrast=createContrast(c(0,1,0,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.joint_ngcb_IPI_DA,format_vals = TRUE,top_n=10, show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(diffcyt::topTable(pool.joint_ngcb_IPI_DA,format_vals = TRUE,top_n=10, show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/NGCB-effects-omitND-IPIadj/edgeR-repeatMeasure/","/NGCB-IPI-jointEffect.omitND.NGCB.vs.GCB_noContrast.RepeatMeasure.csv"))
}
##convergence issues with mixed, so repeated measures is used here.
# markersTest<-rownames(rowData(sce))%in%c("PDL1","PDL2","Tim3","PD1","Lag3","ICOS","Vimentin","CXCR3","CCR4","Vista")
pool.ngcb_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
# formula = formula,
design=design,
#markers_to_test = markersTest,
contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.ngcb_DS,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(diffcyt::topTable(pool.ngcb_DS,format_vals = TRUE,top_n=30, show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/NGCB-effects-omitND-IPIadj/edgeR-repeatMeasure/","/STATE_NGCB.omitND.NGCB.vs.GCB_noContrast.RepeatMeasure.csv"))
}
# as<-  plotMedianExpressionBoxplot(d_medians=ngcb_DS$d_medians,cluster="Exh_Inflam_CD8",marker="C",clinicalFactor="NGCB")
# bs<-  plotMedianExpressionBoxplot(d_medians=ngcb_DS$d_medians,cluster="Act_Exh_early_CD4",marker="CXCR3",clinicalFactor="NGCB")
# cs<-  plotMedianExpressionBoxplot(d_medians=ngcb_DS$d_medians,cluster="Tumor",marker="CXCR3",clinicalFactor="NGCB")
# ds<-  plotMedianExpressionBoxplot(d_medians=ngcb_DS$d_medians,cluster="PDL1M2MAC",marker="Vista",clinicalFactor="NGCB")
#   grid.arrange(as,bs,cs,ds, nrow=2)
##joint effect of IPI and REF
pool.joint_ngcb_IPI_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
# formula = formula,
design=design,
#markers_to_test = markersTest,
contrast=createContrast(c(0,1,0,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.joint_ngcb_IPI_DS,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(diffcyt::topTable(pool.joint_ngcb_IPI_DS,format_vals = TRUE,top_n=30, show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/NGCB-effects-omitND-IPIadj/edgeR-repeatMeasure/","/STATE_NGCB.JOINT-EFFECT_omitND.NGCB.vs.GCB_noContrast.RepeatMeasure.csv"))
}
#plotDiffHeatmap(sce, rowData(joint_ngcb_IPI_DS$res), top_n = 5, fdr = 0.05, lfc=0)
#########################################
##refractory  effects contrasted against age, sex, ethnicity
## refractory is not associated with age, gender, ethnicity
## refractory is association with IPI and NGCB (we average those)
## refractory is marginal associated with LDH.
############# repeated measures.
pool.ref_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
#contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,1,0,0,0,0,0,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.ref_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.ref_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/REF.vs.CR.adjIPI.omitND/edgeR-repeatMeasure","/REF.vs.CR.omitND.noContrast_repeatMeasure.csv"))
}
# aNG<- plotAbundanceCPMDiffCyt(d_counts=ref_DA$d_counts,cluster="PDL1M2MAC",marker=NULL,clinicalFactor="REF")
#  aNG2<- plotAbundanceCPMDiffCyt(d_counts=ref_DA$d_counts,cluster="Act_prol_TREG",marker=NULL,clinicalFactor="REF")
#grid.arrange(aNG,aNG2,nrow=1)
## REF, IPI joint effect.
pool.joint_ref_IPI_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
#contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,1,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.joint_ref_IPI_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)
plotAbundances(sce, k = "merging1",group_by='REF', by = "cluster_id")
if(writeToFile){
write.csv(as.data.frame(topTable(pool.joint_ref_IPI_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/REF.vs.CR.adjIPI.omitND/edgeR-repeatMeasure","/REF.IPI_jointEffect.omitND.noContrast_repeatMeasure.csv"))
}
##states.
pool.ref_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
# markers_to_test = markersTest,
contrast=createContrast(c(0,0,1,0,0,0,0,0,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.ref_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.ref_DS,format_vals = TRUE,top_n=30,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/REF.vs.CR.adjIPI.omitND/edgeR-repeatMeasure","/STATES_REF.vs.CR.omitND.noContrast_repeatMeasure.csv"))
}
#as<-  plotMedianExpressionBoxplot(d_medians=ref_DS$d_medians,cluster="Hi_Supp_TREG",marker="Ki67",clinicalFactor="REF")
#bs<-  plotMedianExpressionBoxplot(d_medians=ref_DS$d_medians,cluster="Hi_Supp_TREG",marker="p",clinicalFactor="REF")
#cs<-  plotMedianExpressionBoxplot(d_medians=ref_DS$d_medians,cluster="Act_Exh_early_CD4",marker="CXCR3",clinicalFactor="REF")
#ds<-  plotMedianExpressionBoxplot(d_medians=ref_DS$d_medians,cluster="Endothelial",marker="PDL1",clinicalFactor="REF")
#   grid.arrange(as,bs,cs,ds, nrow=2)
### JOINT EFFECT OF IPI AND REF
pool.joint_ref_IPI_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
# markers_to_test = markersTest,
contrast=createContrast(c(0,0,1,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.joint_ref_IPI_DS,format_vals = TRUE,top_n=15,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.joint_ref_IPI_DS,format_vals = TRUE,top_n=70,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/REF.vs.CR.adjIPI.omitND/edgeR-repeatMeasure","/STATES_REF.vs.CR.JOINTEFFECT_omitND.noContrast_repeatMeasure.csv"))
}
plotDiffHeatmap(sce2, rowData(pool.joint_ref_IPI_DS$res), top_n = 10, fdr = 0.05,lfc=0)
##joint IPI, REF, COO
pool.joint_ref_NGCB_IPI_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
#contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,rep(0,7))),
contrast=createContrast(c(0,1,1,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.joint_ref_NGCB_IPI_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.joint_ref_NGCB_IPI_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/REF.vs.CR.adjIPI.omitND/edgeR-repeatMeasure","/REF.NGCB_IPI_jointEffect.omitND.noContrast_repeatMeasure.csv"))
}
pool.joint_ref_NGCB_IPI_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
# markers_to_test = markersTest,
contrast=createContrast(c(0,1,1,0,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.joint_ref_NGCB_IPI_DS,format_vals = TRUE,top_n=30,show_logFC = TRUE)%>%as.data.frame
if(writeToFile){
write.csv(as.data.frame(topTable(pool.joint_ref_NGCB_IPI_DS,format_vals = TRUE,top_n=70,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/multivariate-contrasts","/STATES_REF.NGCB_IPI_JOINTEFFECT_omitND.repeatMeasure.csv"))
}
plotDiffHeatmap(sce2, rowData(pool.joint_ref_NGCB_IPI_DS$res), top_n = 10, fdr = 0.05,lfc=0)
##double expressor.
##joint IPI, REF, COO
pool.de_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
#contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,0,0,0,0,0,0,0,0,1,rep(0,7))),
verbose = FALSE)
topTable(pool.de_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.de_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/doubleExpressor/","/DE.omitND.noContrast_repeatMeasure.csv"))
}
pool.joint_de_DA <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
#contrast=createContrast(c(0,1,0,0,0,0,0,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,0,0,0,0,0,0,1,0,1,rep(0,7))),
verbose = FALSE)
topTable(pool.joint_de_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.de_DA,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/doubleExpressor/","/DE_jointIPI.omitND.noContrast_repeatMeasure.csv"))
}
###############################################################
# CHAPUY CLUSTER ANALYSIS
###############################################################
## C1- (c2+C3+C4+C5)-(1/4)(IPI+Ethnic+Gender+surgeryOnly)
###repeated measures.
pool.C1_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
contrast=createContrast(c(0,0,0,1,-1,-1,-1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C1_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C1_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C1/repeat-measures","/C1.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#aNG<- plotAbundanceCPMDiffCyt(d_counts=C1_DA_RM$d_counts,cluster="Baseline_CD4",marker=NULL,clinicalFactor="C1")
## Joint effect of C1, IPI. (NULL)
pool.C1_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
contrast=createContrast(c(0,0,0,1,0,0,0,0,1,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C1_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
#plotAbundances(sce,k="custom",by="sample_id",group_by="C1")
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C1_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C1/repeat-measures","/C1.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#aNG<- plotAbundanceCPMDiffCyt(d_counts=C1_DA_RM$d_counts,cluster="Baseline_CD4",marker=NULL,clinicalFactor="C1")
##examine the states.
pool.C1_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
contrast=createContrast(c(0,0,0,1,-1,-1,-1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.C1_DS,format_vals = TRUE,top_n=10, show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C1_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C1/repeat-measures","/STATES_C1.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#as<-  plotMedianExpressionBoxplot(d_medians=C1_DS$d_medians,cluster="Hi_Supp_TREG",marker="Vimentin",clinicalFactor="C1")
#bs<-  plotMedianExpressionBoxplot(d_medians=C1_DS$d_medians,cluster="M1MAC",marker="HLADR",clinicalFactor="C1")
#   grid.arrange(as,bs, nrow=1)
### repeat measures.
#repeated measures.
pool.C2_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
contrast=createContrast(c(0,0,0,-1,1,-1,-1,-1,1,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C2_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C2_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C2/repeat-measures","/C2.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#ac1<- ggplot(lcpm,aes(x=factor(C2),y=PDL1M2MAC))+geom_boxplot()+ggtitle("PDL1M2MAC")
##repeat measures.
#examine the states.
pool.C2_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
# markers_to_test = markersTest,
contrast=createContrast(c(0,0,0,-1,1,-1,-1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.C2_DS,format_vals = TRUE,top_n=20, show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C2_DS,format_vals = TRUE,top_n=20,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C2/repeat-measures","/STATES_C2.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#as<-  plotMedianExpressionBoxplot(d_medians=C2_DS$d_medians,cluster="Tumor",marker="Ki67",clinicalFactor="C2")
#   bs<-  plotMedianExpressionBoxplot(d_medians=C2_DS$d_medians,cluster="Hi_Supp_TREG",marker="Ki67",clinicalFactor="C2")
#  cs<-  plotMedianExpressionBoxplot(d_medians=C2_DS$d_medians,cluster="Endothelial",marker="Ki67",clinicalFactor="C2")
#   grid.arrange(as,bs,cs, nrow=2)
###repeat measures.
pool.C3_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
# contrast=createContrast(c(0,0,-1/4,-1/4,1,-1/4,-1/4,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,0,-1,-1,1,-1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C3_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C3_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C3/repeat-measures","/C3.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
# a<-ggplot(n_cells[which(n_cells$cluster_id=="Baseline_TREG"),],aes(x=factor(C3),y=n))+geom_boxplot()+ggtitle("Baseline TREG")
#   b<- ggplot(n_cells[which(n_cells$cluster_id=="Baseline_CD4"),],aes(x=factor(C3),y=n))+geom_boxplot()+ggtitle("Baseline CD4")
###
##repeat measures.
#examine the states.
pool.C3_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design=design,
# markers_to_test = markersTest,
contrast=createContrast(c(0,0,0,-1,-1,1,-1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
diffcyt::topTable(pool.C3_DS,format_vals = TRUE,top_n=10, show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C3_DS,format_vals = TRUE,top_n=30,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C3/repeat-measures","/STATES_C3.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#   as<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Act_Exh_early_CD4",marker="Granzym",clinicalFactor="C3")
#   bs<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Act_Exh_early_CD4",marker="CXCR3",clinicalFactor="C3")
#  cs<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Act_prol_TREG",marker="Granzym",clinicalFactor="C3")
#  ds<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Term_Exh_CD8",marker="Granzym",clinicalFactor="C3")
#   grid.arrange(as,bs,cs, ds, nrow=2)
##C4
##repeat measure
pool.C4_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
# contrast=createContrast(c(0,0,-1/4,-1/4,-1/4,1,-1/4,0,0,0,rep(0,7))),
contrast=createContrast(c(0,0,0,-1,-1,-1,1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C4_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C4_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C4/repeat-measures","/C4.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
##examine the states C4.
###repeat measure
pool.C4_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design = design,
contrast=createContrast(c(0,0,0,-1,-1,-1,1,-1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C4_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C4_DS,format_vals = TRUE,top_n=35,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C4/repeat-measures","/STATES_C4.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#        as<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Act_Exh_early_CD4",marker="CCR4",clinicalFactor="C4")
#   bs<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Tumor",marker="CXCR3",clinicalFactor="C4")
#  cs<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="Hi_Supp_TREG",marker="ICOS",clinicalFactor="C4")
#  ds<-  plotMedianExpressionBoxplot(d_medians=C3_DS$d_medians,cluster="InflamTumor",marker="Tbet",clinicalFactor="C4")
#   grid.arrange(as,bs,cs, ds, nrow=2)
###C5
##repeat measures.
pool.C5_DA_RM <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DA",
method_DA = "diffcyt-DA-edgeR",
min_cells=50,
min_samples=4,
normalize=TRUE,
#formula = formula,
design=design,
contrast=createContrast(c(0,0,0,-1,-1,-1,-1,1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C5_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C5_DA_RM,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C5/repeat-measures","/C5.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
##examine the states C2.
pool.C5_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design = design,
contrast=createContrast(c(0,0,0,-1,-1,-1,-1,1,0,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C5_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C5_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C5/repeat-measures","/STATES_C5.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
#       as<-  plotMedianExpressionBoxplot(d_medians=C5_DS$d_medians,cluster="PDL1M2MAC",marker="Tbet",clinicalFactor="C5")
# bs<-  plotMedianExpressionBoxplot(d_medians=C5_DS$d_medians,cluster="Tumor",marker="Tim3",clinicalFactor="C5")
#cs<-  plotMedianExpressionBoxplot(d_medians=C5_DS$d_medians,cluster="PDL1M2MAC",marker="Vista",clinicalFactor="C5")
#   grid.arrange(as,bs,cs,  nrow=2)
###Chapuy Comparison C1,C2,C5 vs C3 C4
pool.C125_C34_DS <- diffcyt(sce,
clustering_to_use = "merging1",
analysis_type = "DS",
method_DS = "diffcyt-DS-limma",
min_cells=50,
min_samples=4,
normalize=TRUE,
design = design,
contrast=createContrast(c(0,1,0,1,1,-1,-1,1,1,0,0,rep(0,7))),
verbose = FALSE)
topTable(pool.C125_C34_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)
if(writeToFile){
write.csv(as.data.frame(topTable(pool.C125_C34_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)),
file=paste0("C:/Users/UOSC/Documents/IMC-Ranalysis/DLBCL/blood-revisions-5-1-21/Chapuy-C5/repeat-measures","/STATES_C5.vs.all.omitND.noContrast_repeatMeasure.csv"))
}
plotDiffHeatmap(sce2, rowData(pool.joint_ref_IPI_DS$res), top_n = 10, fdr = 0.05,lfc=0)
diffcyt::topTable(pool.ref_DS,format_vals = TRUE,top_n=10,show_logFC = TRUE)
diffcyt::topTable(pool.joint_ref_IPI_DS,format_vals = TRUE,top_n=15,show_logFC = TRUE)
plotDiffHeatmap(sce2, rowData(pool.joint_ref_IPI_DS$res), top_n = 10, fdr = 0.05,lfc=0)
res<- diffcyt::topTable(pool.joint_ref_IPI_DS,format_vals = TRUE,top_n=15,show_logFC = TRUE)%>%data.frame
res
